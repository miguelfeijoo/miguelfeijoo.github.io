<script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="//golden-layout.com/assets/js/goldenlayout.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.21/angular.min.js"></script>
<link type="text/css" rel="stylesheet" href="//golden-layout.com/assets/css/goldenlayout-base.css" />
<link type="text/css" rel="stylesheet" href="//golden-layout.com/assets/css/goldenlayout-light-theme.css" />

<link rel='stylesheet' type='text/css' href='https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css' >
<link rel='stylesheet' type='text/css' href='https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css' >

<script src='https://code.jquery.com/jquery-1.12.4.js'></script>
<script src='https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js'></script>
<script src='https://cdn.datatables.net/buttons/1.4.0/js/dataTables.buttons.min.js'></script>
<script src='https://cdn.datatables.net/buttons/1.4.0/js/buttons.flash.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js'></script>
<script src='https://cdn.datatables.net/buttons/1.4.0/js/buttons.html5.min.js'></script>
<script src='https://cdn.datatables.net/buttons/1.4.0/js/buttons.print.min.js'></script>

<script src="https://cdn.jsdelivr.net/npm/vega@4.3.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@3.0.0-rc8"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@3.20.0"></script>

<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<!-- NAVIO Step 0: Load the libraries -->
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/navio/dist/navio.min.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.0.1/ol.js"></script>

<template type="text/html" id="fileselectorTemplate">
  <div id='selector' ng-controller="fileselectorController" class="fileselector">
		<p><strong>Select a file of your interest to get to analyze its current attributes </strong>(Accepted Extensions: <i>.csv</i> )</p>
		<p></p>
		<input ng-model='shared.current_data' type="file" accept=".csv" id="files" name="file" />

		<div id="tableGoesHere"></div>				
</template>	

<template type="text/html" id="navioTemplate">
    <div id='navio_widget' ng-controller="navioController" class="navio">
    	<div id="navio"></div>
    </div>
</template>	

<template type="text/html" id="spatioTemplate">
    <div id='spatial_id' ng-controller="spatioController" class="spatialviz">
		<div id="text" align="left"></div>
		<p></p>
		<div id="list" align="center"></div>
		<p></p>
		<div id="list2" align="center"></div>
		<p></p>
		<p></p>
		<div id="spatial"></div>
    </div>
</template>	

<template type="text/html" id="temporalTemplate">
	<div id='temporal_id' ng-controller="temporalController" class="temporalviz">
    	  <div id="list3" align="center"></div>
		  <div id="temporal"></div>
    </div>
</template>	

<template type="text/html" id="boxplotTemplate">
	<div id='boxplotid' ng-controller="boxplotController" class="boxplot">
		<div id="list4" align="center"></div>
		<div id="boxplot"></div>
	</div>
</template>

<template type="text/html" id="mapTemplate">
	<div id='mapid' ng-controller="mapController" class="map">
		<div id="map"></div>
	</div>
</template>

<style type="text/css">
	body .lm_content{
	  overflow: scroll;
	}	
	#map { overflow: scroll}
</style>


<script type="text/javascript">
	var fileselectorApp = angular.module('fileselector', ['test-service'] );
	var navioApp = angular.module('navio', ['test-service'] );
	var spatioApp = angular.module('spatialviz', ['test-service'] );
	var temporalApp = angular.module('temporalviz', ['test-service'] );
	var boxplotApp = angular.module('boxplot', ['test-service'] );
	var mapApp = angular.module('map', ['test-service'] );


	angular.module('test-service', []).service('TestService', function($rootScope, $window){

	  var datos= null;
	  var seq= null;
	  var cat= null;


	  $window.rootScopes = $window.rootScopes || [];
	    $window.rootScopes.push($rootScope);

	   if (!!$window.sharedService){
	      return $window.sharedService;
	    }
	    
	    $window.sharedService = {      
	      get: function(){
	        return datos;
	      },
	      getData: function(callback) {
		  	$(function()
			{
				$('#files').change( function(event) {
				var tmppath = URL.createObjectURL(event.target.files[0]);
				console.log(tmppath)


				var fmt1 = d3.timeParse("%m/%d/%Y %H:%M:%S %p");
				var fmt2 = d3.timeParse("%m/%d/%Y %H:%M:%S ");
				var fmt3 = d3.timeParse("%m/%d/%Y %H:%M");
				var fmt4 = d3.timeParse("%d/%m/%Y %H:%M:%S %p");
				var fmt5 = d3.timeParse("%d/%m/%Y %H:%M:%S ");
				var fmt6 = d3.timeParse("%d/%m/%Y %H:%M");
				var fmt7 = d3.timeParse("%Y/%m/%d %H:%M:%S %p");
				var fmt8 = d3.timeParse("%Y/%m/%d %H:%M:%S ");
				var fmt9 = d3.timeParse("%Y/%m/%d %H:%M");
				var fmt10 = d3.timeParse("%m-%d-%Y %H:%M:%S %p");
				var fmt11 = d3.timeParse("%m-%d-%Y %H:%M:%S ");
				var fmt12 = d3.timeParse("%m-%d-%Y %H:%M");
				var fmt13 = d3.timeParse("%d-%m-%Y %H:%M:%S %p");
				var fmt14 = d3.timeParse("%d-%m-%Y %H:%M:%S ");
				var fmt15 = d3.timeParse("%d-%m-%Y %H:%M");
				var fmt16 = d3.timeParse("%Y-%m-%d %H:%M:%S %p");
				var fmt17 = d3.timeParse("%Y-%m-%d %H:%M:%S ");
				var fmt18 = d3.timeParse("%Y-%m-%d %H:%M");


				d3.csv(tmppath, function (d) { 
						if (d.hasOwnProperty("Latitud")){
						     d["Latitude"] = +d["Latitud"];
						    delete d["Latitud"];
						}
						else if(d.hasOwnProperty("latitud")){
						    d["Latitude"] = +d["latitud"];
						    delete d["latitud"];
						}
						else if (d.hasOwnProperty("Longitud")){
						     d["Longitude"] = +d["Longitud"];
						    delete d["Longitud"];
						}
						else if(d.hasOwnProperty("longitud")){
						    d["Longitude"] = +d["longitud"];
						    delete d["longitud"];
						}
						else if (!d.hasOwnProperty("Latitude") && !d.hasOwnProperty("Longitude")){
						 var x=Object.keys(d)
						 for(var i=0;i<x.length;i++){
						  //console.log(d[x[i]])
						  if (/(\()?(\-)?([0-9]){1,3}(\.){1}([0-9]){2,10}( )?(\,)?(\;)?(\-)?( )?(\-)?([0-9]){1,3}(\.){1}([0-9]){1,10}(\))?/.test(d[x[i]])){
						    d['Latitude']=+d[x[i]].split(',')[0].split('(')[1]
						    d['Longitude']=+d[x[i]].split(',')[1].split(')')[0]
						    delete d[x[i]];					        
						  }
						 }
						}

						if (d.hasOwnProperty("Fecha")){
						d["Date"] = d["Fecha"];
						delete d["Fecha"];
						if (/[a]{1}\.( )?[m]{1}\./.test(d.Date)){
						d.Date = d.Date.replace(/[a]{1}\.( )?[m]{1}\./, "AM");
						seqColumnsconsole.log(d.Date)
						}
						else if (/[p]{1}\.( )?[m]{1}\./.test(d.Date)){
						d.Date = d.Date.replace(/[p]{1}\.( )?[m]{1}\./, "PM");
						console.log(d.Date)
						} 
						}
						else if (d.hasOwnProperty("fecha")){
						d["Date"] = d["fecha"];
						delete d["fecha"];
						if (/[a]{1}\.?( )[m]{1}\.\./.test(d.Date)){
						d.Date = d.Date.replace(/[a]{1}\.?( )[m]{1}\./, "AM");
						}
						else if (/[p]{1}\.?( )[m]{1}\./.test(d.Date)){
						d.Date = d.Date.replace(/[p]{1}\.?( )[m]{1}\./, "PM");
						} 
						}

						// This function is applied to each row of the dataset
						if(fmt1(d.Date)!=null){
						  d.Date = fmt1(d.Date);
						}
						else if (fmt2(d.Date)!=null){
						  d.Date = fmt2(d.Date);
						}
						else if (fmt3(d.Date)!=null){
						  d.Date = fmt3(d.Date);
						}
						else if (fmt4(d.Date)!=null){
						  d.Date = fmt4(d.Date);
						}
						else if (fmt5(d.Date)!=null){
						  d.Date = fmt5(d.Date);
						}
						else if (fmt6(d.Date)!=null){
						  d.Date = fmt6(d.Date);
						}
						else if (fmt7(d.Date)!=null){
						  d.Date = fmt7(d.Date);
						}
						else if (fmt8(d.Date)!=null){
						  d.Date = fmt8(d.Date);
						}
						else if (fmt9(d.Date)!=null){
						  d.Date = fmt9(d.Date);
						}
						else if (fmt10(d.Date)!=null){
						  d.Date = fmt10(d.Date);
						}
						else if (fmt11(d.Date)!=null){
						  d.Date = fmt11(d.Date);
						}
						else if (fmt12(d.Date)!=null){
						  d.Date = fmt12(d.Date);
						}
						else if (fmt13(d.Date)!=null){
						  d.Date = fmt13(d.Date);
						}
						else if (fmt14(d.Date)!=null){
						  d.Date = fmt14(d.Date);
						}
						else if (fmt15(d.Date)!=null){
						  d.Date = fmt15(d.Date);
						}
						else if (fmt16(d.Date)!=null){
						  d.Date = fmt16(d.Date);
						}
						else if (fmt17(d.Date)!=null){
						  d.Date = fmt17(d.Date);
						}
						else if (fmt18(d.Date)!=null){
						  d.Date = fmt18(d.Date);
						}
						d.Hours = d.Date.getHours();
						d.DayNight = d.hour < 6 && d.hour>18 ? "night": "day";
						d.DayOfTheWeek = d.Date.getDay();
						d.Minutes = d.Date.getMinutes();
						d.Seconds = d.Date.getSeconds();
						d.Year = d.Date.getFullYear().toString();
						d.Month = d.Date.getMonth();
						d.Day = d.Date.getDate();
						return d;

						},  function (err, data) {	
						 	dat=data;
						 	callback(dat);
						});			
				});				
			});	
		}, changeData: function(newArr){
	        datos = newArr;
	        angular.forEach($window.rootScopes, function(scope) {
	          if(!scope.$$phase) {
	              scope.$apply();
	          }
	        });
	        return datos;
	      }, getSeqColumns: function(){
	        return seq;
	      }, changeSeqColumns: function(newArr){
	        seq = newArr;
	        angular.forEach($window.rootScopes, function(scope) {
	          if(!scope.$$phase) {
	              scope.$apply();
	          }
	        });
	        return seq;
	      }, getCatColumns: function(){
	        return cat;
	      }, changeCatColumns: function(newArr){
	        cat = newArr;
	        angular.forEach($window.rootScopes, function(scope) {
	          if(!scope.$$phase) {
	              scope.$apply();
	          }
	        });
	        return cat;
	      }

	    }

	    return $window.sharedService;
	})

	fileselectorApp.controller('fileselectorController', ["$scope",'$timeout',"container","state","TestService",function($scope,$timeout,container,state, TestService) {	

		$scope.dat= state.dat || null;
		$scope.datos= state.datos || null;
		$scope.dataFinal= state.dataFinal || null;

		$scope.seq= state.seq || null;
		$scope.seqColumns= state.seqColumns || null;
		$scope.seqColumnsFinal= state.seqColumnsFinal || null;

		$scope.cat= state.cat || null;
		$scope.catColumns= state.catColumns || null;
		$scope.catColumnsFinal= state.catColumnsFinal || null;

		TestService.getData(function(d){
			$scope.dat =d;

			var parse=[];
	    	var dateparse=[];
	   		var categoric=[];

			function json2table(json, classes) {

			var cols = Object.keys(json[0]);
			  
			var headerRow = '';
			var bodyRows = '';
			var columnas='';
			var columnasSeq='';
			var columns=[];
			  
			classes = classes || '';

			function capitalizeFirstLetter(string) {
			    return string.charAt(0).toUpperCase() + string.slice(1);
			}
			  
			json.map(function(row) {
			    bodyRows += '<tr>';
			    cols.map(function(colName) {
			      bodyRows += '<td>' + row[colName] + '</td>';
			      columns.push(row[colName])
			      console.log(cols.length)
			    })
				bodyRows += '</tr>';
			});

			for (i = 0; i < cols.length; i++){
			    if(/^[+-]?([0-9]*[.])?[0-9]+$/.test(columns[i]))
			    { 
			     parse.push(cols[i])
			    }
			    else if(/([0-9]{0,4})([0-9]{0,4})?(\/)([0-9]{0,4})([0-9]{0,4})?(\/)(\d{0,4})/.test(columns[i]))
			    {
			      dateparse.push(cols[i])
			    } 

			    else if(/[GMT-]{4}[0-9]{4}/.test(columns[i]))
			    {
			      dateparse.push(cols[i])
			    }  
			    else
			    {
			      categoric.push(cols[i])
			    }
			}

			if(parse.includes('Year') && categoric.includes('Year')){

			    var value = 'Year'

			    parse=parse.filter(function(item) { 
			    return item !== value
			 })}

			$scope.seq=parse;

			for (var i=0;i<dateparse.length;i++){
			       $scope.seq.push(dateparse[i])      

			  }

			$scope.cat=categoric;

			cols.map(function(col) {
			headerRow += '<th>' + capitalizeFirstLetter(col) + '</th>';

			columnas += '<option value="'+col+'">'
			});

			$scope.seq.map(function(col) {

			if (col=="Year" ||  col=="Day" || col=="DayNight" || col=="Minutes" || col=="Month" || col=="DayOfTheWeek" || col=="Latitude" || col=="Longitude" || col=="DayNight" || col=="Date" || col== "Hours" || col=="Seconds"){
			    columnasSeq += ''
			}
			else{
			    columnasSeq += '<option value="'+col+'">'
			}
			});

			container.layoutManager.eventHub.emit( 'columnas_list', columnas );
			container.layoutManager.eventHub.emit( 'columnasSeq_list', columnasSeq );

			return '<table id="data" class="display nowrap" style="width:100%">'+'<thead><tr>' +
			     headerRow +
			     '</tr></thead><tbody>' +
			     bodyRows +
			     '</tbody></table>';
			}
			
			document.getElementById('tableGoesHere').innerHTML = json2table($scope.dat, 'table');
			$(document).ready(function() {
				$('#data').DataTable( {  
	    			"scrollY": 300,
	    			"scrollX": true
	    		} );
			} );

			function loadScript(src) {
			       var script = document.createElement("script");
			       script.type = "text/javascript";
			       document.getElementById("tableGoesHere").appendChild(script);
			       script.src = src;		      
			}
			function loadStyle(src) {
			       var script = document.createElement("link");
			       script.rel = 'stylesheet'
			       script.type = "text/css";
			       document.getElementById("tableGoesHere").appendChild(script);
			       script.href = src;
			}

			$(document).ready(function() {
			$('#data').DataTable( {
				destroy: true,
			    dom: 'lBfrtip',
			    buttons: [
			        'copy', 'csv', 'excel', 'pdf', 'print'
			    ],
			    "scrollY": 300,
	    		"scrollX": true
			} );
			} );

			loadStyle('https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css')
			loadStyle('https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css')
			loadScript('https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js')
			loadScript('https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js')
			loadScript('https://cdn.datatables.net/buttons/1.5.2/js/buttons.flash.min.js')
			loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js')
			loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js')
			loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js')
			loadScript('https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js')
			loadScript('https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js')

			var script = document.createElement("script");
			script.text="var table; $(document).ready(function() {$('#visible').DataTable( {destroy: true,paging: true, searching: true, dom: 'lBfrtip', buttons: ['copy', 'csv', 'excel', 'pdf', 'print']} );} );"
			document.getElementById("tableGoesHere").appendChild(script);

			otherfunction();
		})

		function otherfunction(){
			$scope.datos=$scope.dat
			$scope.seqColumns=$scope.seq
			$scope.catColumns=$scope.cat

			container.layoutManager.eventHub.emit( 'datosiniciales', $scope.datos );
			container.layoutManager.eventHub.emit( 'seqiniciales', $scope.seqColumns );
			container.layoutManager.eventHub.emit( 'catiniciales', $scope.catColumns );

		}

		container.layoutManager.eventHub.on( 'datosiniciales', function( datosiniciales ){
			container.layoutManager.eventHub.on( 'seqiniciales', function( seqiniciales ){
				container.layoutManager.eventHub.on( 'catiniciales', function( catiniciales ){

			$scope.data=jQuery.extend(true, [], datosiniciales);
			$scope.dataFinal=TestService.changeData($scope.data)
			$scope.dataFinal=TestService.get();

			$scope.seqCols=jQuery.extend(true, [], seqiniciales);
			$scope.seqColumnsFinal=TestService.changeSeqColumns($scope.seqCols)
			$scope.seqColumnsFinal=TestService.getSeqColumns();


			$scope.catCols=jQuery.extend(true, [], catiniciales);
			$scope.catColumnsFinal=TestService.changeCatColumns($scope.catCols)
			$scope.catColumnsFinal=TestService.getCatColumns();		

			container.layoutManager.eventHub.emit( 'datos', $scope.dataFinal );
			container.layoutManager.eventHub.emit( 'seqColumns', $scope.seqColumnsFinal );
			container.layoutManager.eventHub.emit( 'catColumns', $scope.catColumnsFinal );

					})
				})
			})	
	}])

	navioApp.controller('navioController', ["$scope",'$timeout',"container","state","TestService",function( $scope,$timeout,container, state,TestService ) { 

		container.layoutManager.eventHub.on( 'datos', function( data ){
				container.layoutManager.eventHub.on( 'seqColumns', function( seqColumns ){
					container.layoutManager.eventHub.on( 'catColumns', function( catColumns ){

					container.extendState({dataFinal:data,
						seqColumnsFinal:seqColumns,
						catColumnsFinal:catColumns
					});

					nv=navio(d3.select("#navio"), 600);

					catColumns.forEach((c) => nv.addCategoricalAttrib(c));
					seqColumns.forEach((c) => nv.addSequentialAttrib(c));
					
					nv.data(data);

					visible = nv.getVisible();	
					container.layoutManager.eventHub.emit( 'datosvisibles', visible );	

					nv.updateCallback(function(){
						visible = nv.getVisible();
						container.layoutManager.eventHub.emit( 'datosvisibles', visible );

						container.layoutManager.eventHub.on( 'change-attr1', function( attr1 ){
							container.layoutManager.eventHub.on( 'change-attr2', function( attr2 ){
								container.layoutManager.eventHub.on( 'vis', function( vis ){
									vis(attr1,attr2,seqColumns,catColumns,visible)
								})
							})
						})
					})

				});
			});
		});
	}])


	spatioApp.controller('spatioController', ["$scope",'$timeout',"container","state","TestService",function( $scope,$timeout,container, state,TestService ) { 

		
		
		container.layoutManager.eventHub.on( 'columnas_list', function( cols ){			
			container.layoutManager.eventHub.on( 'seqColumns', function( seqColumns ){
				container.layoutManager.eventHub.on( 'catColumns', function( catColumns ){
					container.layoutManager.eventHub.on( 'datosvisibles', function( datos ){

						document.getElementById("text").innerHTML='<p><strong>Select two attributes from this dataset that you would like to analize graphically:</strong></p>'
						document.getElementById("list").innerHTML = '<strong>Attribute 1:</strong><input list="attrs1" type="text" id="attr1"><datalist id="attrs1">'+cols
						document.getElementById("list2").innerHTML = '<strong>Attribute 2:</strong> <input list="attrs2" type="text" id="attr2"><datalist id="attrs2">'+cols

						function drawViz(seqColumns,catColumns,attr1,attr2,visible)
						{
							console.log("se llamo el metodo")

							if(seqColumns.includes(attr1) && seqColumns.includes(attr2) && (attr1!='Date' && attr2!='Date')){
								var yourVlSpec = {
									"width": 1000,
									"height": 300,
									"autosize": {"type": "fit", "contains": "padding"},
									"data": {"values":visible},
									"transform": [{"calculate": "year(datum.Year)", "as": "Year"},{"filter": {"selection": "brush"}}],
									"selection": {
									"grid": {
									"type": "interval", "bind": "scales"
								},
									"CylYr": {
									"type": "single",
									"fields": ["Year"],
									"bind": {
									"Year": {"input": "range", "min": d3.min(visible,d=>+d.Year-1).toString(), "max":d3.max(visible,d=>+d.Year-1).toString(), "step": 1}
								},
									"on": "click",
									"resolve": "global",
									"empty": "all"
								}
								},
									"mark": "circle",
									"encoding": {
									"x": {"field": attr1, "type": "quantitative"},
									"y": {"field": attr2, "type": "quantitative"},
									"color": {
									"condition": {"selection": "CylYr", "field": "Year", "type": "nominal"},
									"value": "#D8D8D8"
									},
									"size": {
										"condition": {
										  "selection": "CylYr",
										  "value": 100,
										  "fill":'None'
										}
									}
								}
							}
							container.layoutManager.eventHub.emit( 'yourVlSpec', yourVlSpec );	
							spatial(yourVlSpec,visible)
							
							}

							else if(catColumns.includes(attr1) && seqColumns.includes(attr2)){
							 var yourVlSpec = {
							      "width": 1000,
							      "height": 300,
							      "autosize": {"type": "fit", "contains": "padding"},
							      "data": {"values":visible},
							      "transform": [{"calculate": "year(datum.Year)", "as": "Year"},{"filter": {"selection": "brush"}}],
							      "selection": {
							      "grid": {
							      "type": "interval", "bind": "scales"
							      },
							      "CylYr": {
							      "type": "single",
							      "fields": ["Year"],
							      "bind": {
							      "Year": {"input": "range", "min": d3.min(visible,d=>+d.Year-1).toString(), "max":d3.max(visible,d=>+d.Year-1).toString(), "step": 1}
							      },
							      "on": "click",
							      "resolve": "global",
							      "empty": "all"
							      }
							      },
							      "mark": "bar",
							      "encoding": {
							      "x": {"field": attr1, "type": "ordinal"},
							      "y": {"field": attr2, "type": "quantitative"},
							      "color": {
							      "condition": {"selection": "CylYr", "field": "Year", "type": "nominal"},
							      "value": "#D8D8D8"
							      },
							      "size": {
							          "condition": {
							              "selection": "CylYr",
							              "value": 100,
							              "fill":'None'
							          	}
							      	}
							     }
							  }
							  container.layoutManager.eventHub.emit( 'yourVlSpec', yourVlSpec );
							  spatial(yourVlSpec,visible)
							
							}
							else if(seqColumns.includes(attr1) && catColumns.includes(attr2)){
							  var yourVlSpec = {
							      "width": 1000,
							      "height": 300,
							      "autosize": {"type": "fit", "contains": "padding"},
							      "data": {"values":visible},
							      "transform": [{"calculate": "year(datum.Year)", "as": "Year"},{"filter": {"selection": "brush"}}],
							      "selection": {
							      "grid": {
							      "type": "interval", "bind": "scales"
							      },
							      "CylYr": {
							      "type": "single",
							      "fields": ["Year"],
							      "bind": {
							      "Year": {"input": "range", "min": d3.min(visible,d=>+d.Year-1).toString(), "max":d3.max(visible,d=>+d.Year-1).toString(), "step": 1}
							      },
							      "on": "click",
							      "resolve": "global",
							      "empty": "all"
							      }
							      },
							      "mark": "bar",
							      "encoding": {
							      "x": {"field": attr2, "type": "ordinal"},
							      "y": {"field": attr1, "type": "quantitative"},
							      "color": {
							      "condition": {"selection": "CylYr", "field": "Year", "type": "nominal"},
							      "value": "#D8D8D8"
							      },
							      "size": {
							          "condition": {
							              "selection": "CylYr",
							              "value": 100,
							              "fill":'None'
							          }
							      }
							     }
							  }
							  container.layoutManager.eventHub.emit( 'yourVlSpec', yourVlSpec );
							  spatial(yourVlSpec,visible)
							
							}
							else if(seqColumns.includes(attr1) && seqColumns.includes(attr2) && (attr1=='Date')){

							  console.log("ENTRÓ ACÁ")

							  var yourVlSpec = {
							      "width": 1000,
							      "height": 300,
							      "autosize": {"type": "fit", "contains": "padding"},
							      "data": {"values":visible},
							      "transform": [{"calculate": "year(datum.Year)", "as": "Year"},{"filter": {"selection": "brush"}}],
							      "selection": {
							      "grid": {
							      "type": "interval", "bind": "scales"
							      }},
							      "mark": {"type":"point"},
							      "encoding": {
							      "x": {"field": attr1, "type": "temporal"},
							      "y": {"field": attr2, "type": "quantitative"}
							  }
							}
							container.layoutManager.eventHub.emit( 'yourVlSpec', yourVlSpec );
							spatial(yourVlSpec,visible)
							
							}
							else if(seqColumns.includes(attr1) && seqColumns.includes(attr2) && (attr2=='Date')){

							  var yourVlSpec = {
							      "width": 1000,
							      "height": 300,
							      "autosize": {"type": "fit", "contains": "padding"},
							      "data": {"values":visible},
							      "transform": [{"calculate": "year(datum.Year)", "as": "Year"},{"filter": {"selection": "brush"}}],
							      "selection": {
							      "grid": {
							      "type": "interval", "bind": "scales"
							      }},
							      "mark": {"type":"point"},
							      "encoding": {
							      "x": {"field": attr2, "type": "temporal"},
							      "y": {"field": attr1, "type": "quantitative"}
							  }
							}
							container.layoutManager.eventHub.emit( 'yourVlSpec', yourVlSpec );
							spatial(yourVlSpec,visible)
							
							}

						}

						var spatial=function(yourVlSpec,visible)
						{
								var spatialvis = {
								            "width": 1000,
								            "height": 300,
								            "data": {"values":visible},
								            "transform": [{"filter": {"selection": "brush"}}],
								            "vconcat": [{
								              "selection": {
								                "brush": {
								                  "type": "interval",
								                  "on": "[mousedown, window:mouseup] > window:mousemove!",
								                  "encodings": ["x", "y"],
								                  "translate": "[mousedown, window:mouseup] > window:mousemove!",
								                  "zoom": "wheel!",
								                  "mark": {"fill": "#333", "stroke": "green"},
								                  "resolve": "global"
								                  }
								              },
								              "width": 700,
								              "mark": "point",
								              "encoding": {
								                "x": {"field": "Longitude","type": "quantitative","scale": {"domain": [d3.min(visible,d => +d.Longitude), d3.max(visible,d => +d.Longitude)]}},
								                "y": {"field": "Latitude","type": "quantitative","scale": {"domain": [d3.min(visible,d => +d.Latitude), d3.max(visible,d => +d.Latitude)]}}
								              }
								            }, yourVlSpec]
								          }
								vegaEmbed("#spatial", spatialvis);
						}

						var vis = function(attr1,attr2,seqColumns,catColumns,visible){
							
							d3.select("#attr1").on("change", function(){
								attr1 = this.value;
								container.layoutManager.eventHub.emit( 'change-attr1', attr1 );	
							  	console.log(attr1)

								drawViz(seqColumns,catColumns,attr1,attr2,visible)	
								
							})

							d3.select("#attr2").on("change", function(){
							  	attr2 = this.value;
							  	container.layoutManager.eventHub.emit( 'change-attr2', attr2 );		

							  	console.log(attr2)

							  	drawViz(seqColumns,catColumns,attr1,attr2,visible)
							})				

						}
						container.layoutManager.eventHub.emit( 'vis', vis(attr1,attr2,seqColumns,catColumns,datos) );
					})
				})
			})
		})		
	}])

	temporalApp.controller('temporalController', ["$scope",'$timeout',"container","state","TestService",function( $scope,$timeout,container, state,TestService ) { 

		container.layoutManager.eventHub.on( 'columnasSeq_list', function( cols ){
			container.layoutManager.eventHub.on( 'datosvisibles', function( datos ){
				container.layoutManager.eventHub.on( 'yourVlSpec', function(yourVlSpec){
					document.getElementById("list3").innerHTML = '<strong>Select Quantitative Value: </strong> <input list="attrs3" type="text" id="attr3"><datalist id="attrs3">'+cols
					var temporal=function(yourVlSpec,visible){
						d3.select("#attr3").on("change", function(){
						  var attrSeq = this.value;
						  console.log("cambioo   attr3 :"+attrSeq)

						  console.log("selected value:     "+attrSeq)

						  var temporalvis = {
						  "data": {"values":visible},
						  "vconcat": [{
						    "width": 700,
						    "mark": "area",
						    "encoding": {
						      "x": {
						        "field": "Date",
						        "type": "temporal",
						        "scale": {"domain": {"selection": "brush"}},
						        "axis": {"title": ""}
						      },
						      "y": {"field": attrSeq,"type": "quantitative"}
						    }
						  }, {
						    "width": 700,
						    "height": 80,
						    "mark": "area",
						    "selection": {
						      "brush": {"type": "interval", "encodings": ["x"],"zoom": "wheel!",
						                  "mark": {"fill": "#333", "stroke": "green"}}
						    },
						    "encoding": {
						      "x": {
						        "field": "Date",
						        "type": "temporal"
						      },
						      "y": {
						        "field": attrSeq,
						        "type": "quantitative",
						        "axis": {"tickCount": 3, "grid": false}
						      }
						    }
						  }, yourVlSpec]
						}
						  vegaEmbed("#temporal", temporalvis);
						});
					}
					temporal(yourVlSpec,datos)
				});
			});
		});
	}])

	boxplotApp.controller('boxplotController', ["$scope",'$timeout',"container","state","TestService",function( $scope,$timeout,container, state,TestService ) {

		container.layoutManager.eventHub.on( 'columnasSeq_list', function( cols ){
			container.layoutManager.eventHub.on( 'datosvisibles', function( datos ){

				var latitudes = [];
				var longitudes=[];
				datos.map(function(d){
					latitudes.push(parseFloat(d.Latitude))
					longitudes.push(parseFloat(d.Longitude))
				})

				console.log(latitudes)
				console.log(longitudes)


				document.getElementById("list4").innerHTML = '<strong>Select Quantitative Value: </strong> <input list="attrs4" type="text" id="attr4"><datalist id="attrs4">'+cols

				function onlyUnique(value, index, self) { 
				    return self.indexOf(value) === index;
				}

				var years_temp=[]
					var years = datos.map(function(d){
						years_temp.push(parseInt(d.Date.getFullYear()))				
					})

				var years_temp_array = years_temp.filter(onlyUnique)
				console.log(years_temp_array)

				d3.select("#attr4").on("change", function(){
					var attr4 = this.value;
					console.log("Selected Value Attr4: "+attr4)		


					var data=[]

					var colors = ['rgb(93, 164, 214, 0.5)', 'rgb(255, 144, 14, 0.5)', 'rgb(44, 160, 101, 0.5)', 'rgb(255, 65, 54, 0.5)', 'rgb(207, 114, 255, 0.5)', 'rgb(127, 96, 0, 0.5)', 'rgb(255, 140, 184, 0.5)', 'rgb(79, 90, 117, 0.5)', 'rgb(222, 223, 0, 0.5)','rgb(0,128,128)','rgb(214,12,140)','rgb(128, 0, 0)','rgb(255,255,0)','rgb(128,128,0)','rgb(0,255,255)','rgb(0,0,255)','rgb(255,0,255)','rgb(107,174,214)','rgb(128,0,128)'];

					var new_colors=[];
					if(colors.length>years_temp_array.length){
						new_colors=colors.slice(0,years_temp_array.length+1)
					}				

					for(var i=0;i<years_temp_array.length;i++){	
					
						if (i!=0){				
							new_colors.pop()
						}

						var temp_array_int=[]
						datos.filter(d=>parseInt(d.Date.getFullYear())==years_temp_array[i]).map(function(d){
							temp_array_int.push(parseInt(d[attr4]))
						})

						console.log(temp_array_int)

						for(var j=0;j<new_colors.length;j++){

							data[i]={
							  y: temp_array_int,
							  type: 'box',
							  name: "Year:  "+years_temp_array[i],
							  marker: {
							    color: new_colors[j],
							    outliercolor: 'rgb(219, 64, 82, 0.6)',
							    line: {
							      outliercolor: 'rgb(219, 64, 82, 1.0)',
							      outlierwidth: 2
							    }

							  },
							  boxpoints: 'all'
							};
						}
						
					}

					var layout = {
					  title: 'Representation: Box Plot'
					};

					Plotly.newPlot('boxplot', data, layout);
				})
			})
		})
	}])

	mapApp.controller('mapController', ["$scope",'$timeout',"container","state","TestService",function( $scope,$timeout,container, state,TestService ) {

			container.layoutManager.eventHub.on( 'datosvisibles', function( datos ){

				var colors = ['#006400','#FF00FF','#1E90FF','#000000','#FFFF00','#2F4F4F','#FFFF00','#20B2AA',,'#8B4513','#FFFF00','#FF8C00','#868686'];

				var years =[];
				var lista=[];
				
				datos.map(function(d){
					years.push(d.Year)
					years=years.filter(function(item, pos){
 						return years.indexOf(item)== pos; 
					});
				})

				if(colors.length>years.length){
						new_colors=colors.slice(0,years.length+1)
				}

				for(var k=0;k<years.length;k++){	

					console.log(new_colors)
					if (i!=0){				
							new_colors.pop()
					}

					console.log(new_colors)

					for(var color=0;color<new_colors.length;color++){						
						var latitudes = [];
						var longitudes=[];

						var datos_filter=datos.filter(d=>d.Year==years[k]).map(function(d){						
							latitudes.push(parseFloat(d.Latitude))
							longitudes.push(parseFloat(d.Longitude))
						})		

						console.log("YEAR:     "+years[k])
						console.log(latitudes)	
						console.log(longitudes)
						
						for(var i=0;i<datos_filter.length;i++){
							console.log("aaa")
							var coord = [longitudes[i],latitudes[i]];
							lista.push({
								  type: 'Feature',
								  properties: {
								    'marker-color': new_colors[color],
								    'marker-size': 'medium'
								  },
								  geometry: {
								    type: 'Point',
								    coordinates: coord
								  }
							})

							
						}	
					}
			}


						
						var geojsonObject = {
						type: 'FeatureCollection',
						crs: { type: 'name', properties: { name: 'EPSG:4326' }},
						features: lista};

						var features = new ol.format.GeoJSON().readFeatures(geojsonObject, {
							featureProjection: 'EPSG:3857'
						});

						var max_latitudes=Math.max.apply(Math,latitudes)
						var min_latitudes=Math.min.apply(Math,latitudes)
						var max_longitudes=Math.max.apply(Math,longitudes)
						var min_longitudes=Math.min.apply(Math,longitudes)

						var prom_latitudes= (max_latitudes+min_latitudes)/2;
						var prom_longitudes=(max_longitudes+min_longitudes)/2;

						var vectorSource = new ol.source.Vector({ features: features });
						var vectorLayer = new ol.layer.Vector({
							source: vectorSource,
							style: function (feature, resolution) {
								console.log(feature.getProperties(), feature.get('marker-color'));
								return [new ol.style.Style({
								  image: new ol.style.Circle({
								    radius: 5,
								    fill: new ol.style.Fill({ color: feature.get('marker-color') })
								  })
								})];
							}
						});

						var map = new ol.Map({
							target: 'map',
							layers: [
								new ol.layer.Tile({ source: new ol.source.OSM() }),
								vectorLayer
							],
							view: new ol.View({			
								center: ol.proj.fromLonLat([prom_longitudes,prom_latitudes]),
								zoom: 11
							})
						});						
					//}
				})	
			window.onresize = function()
			{
				setTimeout(function(){ map.updateSize()}, 400);
			}
	}])



	var app1El = document.getElementById('fileselector');
	var app2El = document.getElementById('navio');
	var app3El = document.getElementById('spatialviz');
	var app4El = document.getElementById('temporalviz');
	var app5El = document.getElementById('boxplot');
	var app6El = document.getElementById('map');


	angular.bootstrap(app1El, ['fileselector', 'test-service']);
	angular.bootstrap(app2El, ['navio', 'test-service']);
	angular.bootstrap(app3El, ['spatialviz', 'test-service']);
	angular.bootstrap(app4El, ['temporalviz', 'test-service']);
	angular.bootstrap(app5El, ['boxplot', 'test-service']);
	angular.bootstrap(app6El, ['map', 'test-service']);

	var AngularModuleComponent = function( container, state ) {
	    var html = $( '#' + state.templateId ).html(),
	        element = container.getElement();
	    
	    element.html( html );
	 

	    angular
	        .module( state.module )
	        .value( 'container', container )
	        .value( 'state', state );



	        console.log(state.module)

	    angular.bootstrap( element[ 0 ], [ state.module ] );
	};

	var myLayout = new GoldenLayout({
	    content:[{
	        type: 'row',
	        content: [{
	            width: 20,
	            title: 'File Picker',
	            type: 'component',
	            componentName: 'angularModule',
	            componentState: {
	                module: 'fileselector',
	                templateId: 'fileselectorTemplate',
	            }
	        },{
	            type: 'component',
	            title: 'Geo-Referentiation',
	            componentName: 'angularModule',
	            componentState: {
	                module: 'map',
	                templateId: 'mapTemplate'
	            }
	        },{
	            type: 'component',
	            title: 'WHAT - Widget: Navio',
	            componentName: 'angularModule',
	            componentState: {
	                module: 'navio',
	                templateId: 'navioTemplate'
	            }
	        },{
	            type: 'component',
	            title: 'General Statistics',
	            componentName: 'angularModule',
	            componentState: {
	                module: 'boxplot',
	                templateId: 'boxplotTemplate'
	         }
	       },{
	            type: 'component',
	            title: 'WHERE',
	            componentName: 'angularModule',
	            componentState: {
	                module: 'spatialviz',
	                templateId: 'spatioTemplate'
	       		}
	    	},{
	            type: 'component',
	            title: 'WHEN',
	            componentName: 'angularModule',
	            componentState: {
	                module: 'temporalviz',
	                templateId: 'temporalTemplate'
	         }
	       }]
	   }]
	});

	myLayout.registerComponent( 'angularModule', AngularModuleComponent );
	myLayout.init();
</script>