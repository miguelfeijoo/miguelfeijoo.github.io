<script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="//golden-layout.com/assets/js/goldenlayout.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.21/angular.min.js"></script>
<link type="text/css" rel="stylesheet" href="//golden-layout.com/assets/css/goldenlayout-base.css" />
<link type="text/css" rel="stylesheet" href="//golden-layout.com/assets/css/goldenlayout-light-theme.css" />

<link rel='stylesheet' type='text/css' href='https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css' >
<link rel='stylesheet' type='text/css' href='https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css' >

<script src='https://code.jquery.com/jquery-1.12.4.js'></script>
<script src='https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js'></script>
<script src='https://cdn.datatables.net/buttons/1.4.0/js/dataTables.buttons.min.js'></script>
<script src='https://cdn.datatables.net/buttons/1.4.0/js/buttons.flash.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js'></script>
<script src='https://cdn.datatables.net/buttons/1.4.0/js/buttons.html5.min.js'></script>
<script src='https://cdn.datatables.net/buttons/1.4.0/js/buttons.print.min.js'></script>

<script src="https://cdn.jsdelivr.net/npm/vega@4.3.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@3.0.0-rc8"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@3.20.0"></script>

<script src="http://d3js.org/queue.v1.min.js"></script>

<!-- NAVIO Step 0: Load the libraries -->
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/navio/dist/navio.min.js"></script>

<template type="text/html" id="fileselectorTemplate">
  <ul ng-controller="fileselectorController" class="fileselector">
		<p><strong>Select a file of your interest to get to analyze its current attributes </strong>(Accepted Extensions: <i>.csv</i> )</p>
		<p></p>
		<input ng-model='shared.current_data' type="file" accept=".csv" id="files" name="file" />
		<div id="tableGoesHere"></div>				
</template>

<template type="text/html" id="userDetailTemplate">
    <div ng-controller="userdetailsController" class="userdetails">
      <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/152047/{{user.img}}" width="100" height="100" />
      <h2>{{user.name}}</h2>
      <p>{{user.street}}</p>
    </div>
</template>


<style type="text/css">
	.fileselector *,
	.userdetails{
	    color: #000;
	    font: 12px Arial, sans-serif;
	}
	.fileselector{
	    margin: 0;
	    padding: 0;
	}
	template{
	  display:none;
	}
	.fileselector li{
	    padding: 10px;
	    border-bottom: 1px solid #555;
	    cursor: pointer;
	    list-style-type: none;
	}

	.fileselector li:hover{
	    background: #666;
	}

	.fileselector li.selected{
	    background: orange;
	    font-weight: bold;
	}

	.userdetails{
	    padding: 10px;
	    overflow: hidden;
	}

	.userdetails img{
	    float: left;
	    margin-right: 10px;
	}

	.userdetails h2{
	    margin-top: 0;
}
</style>

<script type="text/javascript">
var fileselectorApp = angular.module('fileselector', [] );

fileselectorApp.service('myService',function($timeout){
	var getData = function(callback) {
	  $timeout(function() {
	  	$(function()
		{
			$('#files').change( function(event) {
			var tmppath = URL.createObjectURL(event.target.files[0]);
			console.log(tmppath)


			var fmt1 = d3.timeParse("%m/%d/%Y %H:%M:%S %p");
			var fmt2 = d3.timeParse("%m/%d/%Y %H:%M:%S ");
			var fmt3 = d3.timeParse("%m/%d/%Y %H:%M");
			var fmt4 = d3.timeParse("%d/%m/%Y %H:%M:%S %p");
			var fmt5 = d3.timeParse("%d/%m/%Y %H:%M:%S ");
			var fmt6 = d3.timeParse("%d/%m/%Y %H:%M");
			var fmt7 = d3.timeParse("%Y/%m/%d %H:%M:%S %p");
			var fmt8 = d3.timeParse("%Y/%m/%d %H:%M:%S ");
			var fmt9 = d3.timeParse("%Y/%m/%d %H:%M");
			var fmt10 = d3.timeParse("%m-%d-%Y %H:%M:%S %p");
			var fmt11 = d3.timeParse("%m-%d-%Y %H:%M:%S ");
			var fmt12 = d3.timeParse("%m-%d-%Y %H:%M");
			var fmt13 = d3.timeParse("%d-%m-%Y %H:%M:%S %p");
			var fmt14 = d3.timeParse("%d-%m-%Y %H:%M:%S ");
			var fmt15 = d3.timeParse("%d-%m-%Y %H:%M");
			var fmt16 = d3.timeParse("%Y-%m-%d %H:%M:%S %p");
			var fmt17 = d3.timeParse("%Y-%m-%d %H:%M:%S ");
			var fmt18 = d3.timeParse("%Y-%m-%d %H:%M");


			d3.csv(tmppath, function (d) { 
					if (d.hasOwnProperty("Latitud")){
					     d["Latitude"] = +d["Latitud"];
					    delete d["Latitud"];
					}
					else if(d.hasOwnProperty("latitud")){
					    d["Latitude"] = +d["latitud"];
					    delete d["latitud"];
					}
					else if (d.hasOwnProperty("Longitud")){
					     d["Longitude"] = +d["Longitud"];
					    delete d["Longitud"];
					}
					else if(d.hasOwnProperty("longitud")){
					    d["Longitude"] = +d["longitud"];
					    delete d["longitud"];
					}
					else if (!d.hasOwnProperty("Latitude") && !d.hasOwnProperty("Longitude")){
					 var x=Object.keys(d)
					 for(var i=0;i<x.length;i++){
					  //console.log(d[x[i]])
					  if (/(\()?(\-)?([0-9]){1,3}(\.){1}([0-9]){2,10}( )?(\,)?(\;)?(\-)?( )?(\-)?([0-9]){1,3}(\.){1}([0-9]){1,10}(\))?/.test(d[x[i]])){
					    d['Latitude']=+d[x[i]].split(',')[0].split('(')[1]
					    d['Longitude']=+d[x[i]].split(',')[1].split(')')[0]
					    delete d[x[i]];
					        
					  }
					 }
					}


					if (d.hasOwnProperty("Fecha")){
					d["Date"] = d["Fecha"];
					delete d["Fecha"];
					if (/[a]{1}\.( )?[m]{1}\./.test(d.Date)){
					d.Date = d.Date.replace(/[a]{1}\.( )?[m]{1}\./, "AM");
					console.log(d.Date)
					}
					else if (/[p]{1}\.( )?[m]{1}\./.test(d.Date)){
					d.Date = d.Date.replace(/[p]{1}\.( )?[m]{1}\./, "PM");
					console.log(d.Date)
					} 
					}
					else if (d.hasOwnProperty("fecha")){
					d["Date"] = d["fecha"];
					delete d["fecha"];
					if (/[a]{1}\.?( )[m]{1}\.\./.test(d.Date)){
					d.Date = d.Date.replace(/[a]{1}\.?( )[m]{1}\./, "AM");
					}
					else if (/[p]{1}\.?( )[m]{1}\./.test(d.Date)){
					d.Date = d.Date.replace(/[p]{1}\.?( )[m]{1}\./, "PM");
					} 
					}

					// This function is applied to each row of the dataset
					if(fmt1(d.Date)!=null){
					  d.Date = fmt1(d.Date);
					}
					else if (fmt2(d.Date)!=null){
					  d.Date = fmt2(d.Date);
					}
					else if (fmt3(d.Date)!=null){
					  d.Date = fmt3(d.Date);
					}
					else if (fmt4(d.Date)!=null){
					  d.Date = fmt4(d.Date);
					}
					else if (fmt5(d.Date)!=null){
					  d.Date = fmt5(d.Date);
					}
					else if (fmt6(d.Date)!=null){
					  d.Date = fmt6(d.Date);
					}
					else if (fmt7(d.Date)!=null){
					  d.Date = fmt7(d.Date);
					}
					else if (fmt8(d.Date)!=null){
					  d.Date = fmt8(d.Date);
					}
					else if (fmt9(d.Date)!=null){
					  d.Date = fmt9(d.Date);
					}
					else if (fmt10(d.Date)!=null){
					  d.Date = fmt10(d.Date);
					}
					else if (fmt11(d.Date)!=null){
					  d.Date = fmt11(d.Date);
					}
					else if (fmt12(d.Date)!=null){
					  d.Date = fmt12(d.Date);
					}
					else if (fmt13(d.Date)!=null){
					  d.Date = fmt13(d.Date);
					}
					else if (fmt14(d.Date)!=null){
					  d.Date = fmt14(d.Date);
					}
					else if (fmt15(d.Date)!=null){
					  d.Date = fmt15(d.Date);
					}
					else if (fmt16(d.Date)!=null){
					  d.Date = fmt16(d.Date);
					}
					else if (fmt17(d.Date)!=null){
					  d.Date = fmt17(d.Date);
					}
					else if (fmt18(d.Date)!=null){
					  d.Date = fmt18(d.Date);
					}
					d.Hours = d.Date.getHours();
					d.DayNight = d.hour < 6 && d.hour>18 ? "night": "day";
					d.DayOfTheWeek = d.Date.getDay();
					d.Minutes = d.Date.getMinutes();
					d.Seconds = d.Date.getSeconds();
					d.Year = d.Date.getFullYear().toString();
					d.Month = d.Date.getMonth();
					d.Day = d.Date.getDate();
					return d;
					},  function (err, data) {	

					 	var datos=data;
	    				callback(datos);

					});
			});
		
		});		
	  }, 2000);
	};

	return {
	  getData: getData
	};     
});


fileselectorApp.controller('fileselectorController', ['$scope','myService', function( $scope, myService) {

		myService.getData(function(data) {
			$scope.data = data;

			var parse=[];
    		var dateparse=[];
    		var categoric=[];

			var catColumns = [];
			var seqColumns = [];
			function json2table(json, classes) {
			var cols = Object.keys(json[0]);

			var headerRow = '';
			var bodyRows = '';
			var columnas='';
			var columnasSeq='';
			var columns=[];


			classes = classes || '';
			function capitalizeFirstLetter(string) {
			return string.charAt(0).toUpperCase() + string.slice(1);
			}
			//console.log(cols)
			json.map(function(row) {
			bodyRows += '<tr>';
			cols.map(function(colName) {
			  bodyRows += '<td>' + row[colName] + '</td>';
			  columns.push(row[colName])
			  console.log(cols.length)
			})
			bodyRows += '</tr>';
			});
			for (i = 0; i < cols.length; i++){
			if(/^[+-]?([0-9]*[.])?[0-9]+$/.test(columns[i]))
			{ 
			 parse.push(cols[i])
			}
			else if(/([0-9]{0,4})([0-9]{0,4})?(\/)([0-9]{0,4})([0-9]{0,4})?(\/)(\d{0,4})/.test(columns[i]))
			{
			  dateparse.push(cols[i])
			}  
			else if(/[GMT-]{4}[0-9]{4}/.test(columns[i]))
			{
			  dateparse.push(cols[i])
			}  
			else
			{
			  categoric.push(cols[i])
			}
			}

			//dateparse.push('Hours','Minutes','Seconds','Month','Day')
			//categoric.push('Year','DayNight','DayOfTheWeek')
			if(parse.includes('Year') && categoric.includes('Year')){
			var value = 'Year'
			parse=parse.filter(function(item) { 
			return item !== value
			})}
			seqColumns=parse;

			for (var i=0;i<dateparse.length;i++){
			   seqColumns.push(dateparse[i])
			   
			}
			catColumns=categoric;
			cols.map(function(col) {
			headerRow += '<th>' + capitalizeFirstLetter(col) + '</th>';
			columnas += '<option value="'+col+'">'
			});
			seqColumns.map(function(col) {
			if (col=="Year" ||  col=="Day" || col=="DayNight" || col=="Minutes" || col=="Month" || col=="DayOfTheWeek" || col=="Latitude" || col=="Longitude" || col=="DayNight" || col=="Date" || col== "Hours" || col=="Seconds"){
			    columnasSeq += ''
			}
			else{
			    columnasSeq += '<option value="'+col+'">'
			}
			});
			/*document.getElementById("text").innerHTML='<p><strong>Select two attributes from this dataset that you would like to analize graphically:</strong></p>'
			document.getElementById("list").innerHTML = '<strong>Attribute 1:</strong><input list="attrs1" type="text" id="attr1"><datalist id="attrs1">'+columnas
			document.getElementById("list2").innerHTML = '<strong>Attribute 2:</strong> <input list="attrs2" type="text" id="attr2"><datalist id="attrs2">'+columnas
			document.getElementById("list3").innerHTML = '<strong>Select Quantitative Value: </strong> <input list="attrs3" type="text" id="attr3"><datalist id="attrs3">'+columnasSeq*/
			return '<table id="data" class="display nowrap" style="width:100%">'+'<thead><tr>' +
			     headerRow +
			     '</tr></thead><tbody>' +
			     bodyRows +
			     '</tbody></table>';
			}
			document.getElementById('tableGoesHere').innerHTML = json2table($scope.data, 'table');
			$(document).ready(function() {
    			$('#data').DataTable( {       				
        			"scrollY": 200,
        			scrollx: true
   				 } );
			} );
			/* How to use it */
			function loadScript(src) {
			   var script = document.createElement("script");
			   script.type = "text/javascript";
			   document.getElementById("tableGoesHere").appendChild(script);
			   script.src = src;
			  
			}
			function loadStyle(src) {
			   var script = document.createElement("link");
			   script.rel = 'stylesheet'
			   script.type = "text/css";
			   document.getElementById("tableGoesHere").appendChild(script);
			   script.href = src;
			}
			$(document).ready(function() {
			$('#data').DataTable( {
			    dom: 'Bfrtip',
			    buttons: [
			        'copy', 'csv', 'excel', 'pdf', 'print'
			    ]
			} );
			} );
			loadStyle('https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css')
			loadStyle('https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css')
			//loadScript('https://code.jquery.com/jquery-3.3.1.js')
			loadScript('https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js')
			loadScript('https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js')
			loadScript('https://cdn.datatables.net/buttons/1.5.2/js/buttons.flash.min.js')
			loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js')
			loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js')
			loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js')
			loadScript('https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js')
			loadScript('https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js')
			var script = document.createElement("script");
			script.text="var table; table.destroy(); $(document).ready(function() {$('#visible').DataTable( {destroy: true,paging: true, searching: true, dom: 'Bfrtip', buttons: ['copy', 'csv', 'excel', 'pdf', 'print']} );} );"
			document.getElementById("tableGoesHere").appendChild(script);



			console.log($scope.data)
		});		
			
		

    }]);


angular.module('userdetails', [] )
	.controller('userdetailsController', function( $scope, container, state ) { 



  	 				
    })





var AngularModuleComponent = function( container, state ) {
    var html = $( '#' + state.templateId ).html(),
        element = container.getElement();
    
    element.html( html );

    angular
        .module( state.module )
        .value( 'container', container )
        .value( 'state', state );

    angular.bootstrap( element[ 0 ], [ state.module ] );
};

var myLayout = new GoldenLayout({
    content:[{
        type: 'row',
        content: [{
            width: 20,
            title: 'File Picker',
            type: 'component',
            componentName: 'angularModule',
            componentState: {
                module: 'fileselector',
                templateId: 'fileselectorTemplate',
                selectedUserIndex: 2
            }
        },{
            type: 'component',
            title: 'Selected User',
            componentName: 'angularModule',
            componentState: {
                module: 'userdetails',
                templateId: 'userDetailTemplate'
            }
        }]
    }]
});

myLayout.registerComponent( 'angularModule', AngularModuleComponent );
myLayout.init();
</script>

